# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: DaXueXi

on: 
  schedule:
    - cron: '0 0 */3 * *'
  workflow_dispatch:
    
jobs:

  build:

    runs-on: ubuntu-latest

    steps:
  
    - name: 'Checkout codes'
      uses: actions/checkout@v2

    # REQUIRED step
    # --- not reqired any more
    # Step 2: run the sync action
    # - name: Sync upstream changes
    #   id: sync
    #   uses: aormsby/Fork-Sync-With-Upstream-action@v3.1
    #   with:
    #     target_sync_branch: main
    #     # REQUIRED 'target_repo_token' exactly like this!
    #     target_repo_token: ${{ secrets.GITHUB_TOKEN }}
    #     upstream_sync_branch: main
    #     upstream_sync_repo: startkkkkkk/Beijing_Daxuexi_Simple
      
    # Step 3: Display a sample message based on the sync output var 'has_new_commits'
    - name: New commits found
      if: steps.sync.outputs.has_new_commits == 'true'
      run: echo "New commits were found to sync."
    
    - name: No new commits
      if: steps.sync.outputs.has_new_commits == 'false'
      run: echo "There were no new commits."
      
    - name: Show value of 'has_new_commits'
      run: echo ${{ steps.sync.outputs.has_new_commits }}

    - name: Set up Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Python
      env:
        USERNAME: ${{ secrets.USERNAME }}
        PASSWORD: ${{ secrets.PASSWORD }}
      run: |
        python main.py

    - name: Send email
      uses: dawidd6/action-send-mail@v3.12.0
      with:
        # Specify connection via URL (replaces server_address, server_port, secure,
        # username and password)
        #
        # Format:
        #
        #  * smtp://user:password@server:port
        #  * smtp+starttls://user:password@server:port
        #connection_url: ${{secrets.MAIL_CONNECTION}}
        # Required mail server address if not connection_url:
        server_address: smtp.yeah.net
        # Server port, default 25:
        server_port: 465
        # Optional whether this connection use TLS (default is true if server_port is 465)
        secure: true
        # Optional (recommended) mail server username:
        username: ${{ secrets.MAILUSERNAME }}
        # Optional (recommended) mail server password:
        password: ${{ secrets.MAILPASSWORD }}
        # Required mail subject:
        subject: Github Actions 自动大学习提醒
        # Required recipients' addresses:
        to: vinc049@qq.com
        # Required sender full name (address can be skipped):
        from: kcd # <user@example.com>
        # Optional plain body:
        # body: Build job of ${{github.repository}} completed successfully!
        # Optional HTML body read from file:
        html_body: file://result.txt
        # Optional carbon copy recipients:
        # cc: kyloren@example.com,leia@example.com
        # Optional blind carbon copy recipients:
        # bcc: r2d2@example.com,hansolo@example.com
        # Optional recipient of the email response:
        #reply_to: luke@example.com
        # Optional Message ID this message is replying to:
        #in_reply_to: <random-luke@example.com>
        # Optional unsigned/invalid certificates allowance:
        #ignore_cert: true
        # Optional converting Markdown to HTML (set content_type to text/html too):
        convert_markdown: true
        # Optional attachments:
        #attachments: attachments.zip,git.diff,./dist/static/*.js
        # Optional priority: 'high', 'normal' (default) or 'low'
        #priority: low
        # Optional nodemailerlog: true/false
        # nodemailerlog: true
        # Optional nodemailerdebug: true/false if true lognodem will also be set true
        # nodemailerdebug: false
        content_type: text/html